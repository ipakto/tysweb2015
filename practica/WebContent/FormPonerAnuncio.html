<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
</head>
<body>
<p>
	<label for="categoria">Categoria</label>
	<select id="categoria">
		<option></option>
	</select>
</p>
<p>
	<label for="descripcion"><input id="descripcion" type="text" size="100" maxlength="140"><br>
	</label>
</p>

<div id="zonaDeFotos">
<form id="formFoto" enctype="multipart/form-data" >
	<label for="foto">Fotos</label><input type="file" id="foto" name="foto" accept="image/*"><br>
	<button type="button" id="guardar" onclick="subirFoto()">Subir</button>
	<div id="progreso"></div>
</form>
</div>
<button type="button" id="publicar" onclick="publicarAnuncio()">Publicar</button>
<script>
	//Cargar las categorías existentes
	var request=new XMLHttpRequest();
	request.open("GET","getCategorias.jsp");
	request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	request.onreadystatechange=function(){
		if (request.readyState==4){ //ESTADO DE LA PETICIÓN
			if(request.status==200){//ESTADO De la respuesta devuelta x el servidor
				var respuesta=JSON.parse(request.responseText);
				var categorias=document.getElementById("categoria");
				//Manipulamos objetos DOM para options y select.
				for(var i=0;i<respuesta.length;i++){
					var option=document.createElement("option");
					option.setAttribute("value", respuesta[i].id);
					option.innerHTML=respuesta[i].nombre;	
					categorias.appendChild(option);
				}
			}else{
				alert("Error: " + request.statusText);
			}
		}
	};
	request.send();
	
		function publicarAnuncio(){
			var request= new XMLHttpRequest();
			request.open("POST", "PonerAnuncio.action");
			request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			request.onreadystatechange=function(){
				if(request.readyState==4){
					if(request.status==200){
						var respuesta=JSON.parse(request.responseText);
						if(respuesta.resultado=="OK"){
							$("#datosPersonales").load("FormDPSesion.html");
							alert("Anuncio añadido correctamente.");
						}else{
							alert(respuesta.resultado);
						}
					}else{
						alert("Error: "+request.status);
					}
				}
			}
			var pars="idCategoria="+document.getElementById("categoria").value +
			"&idAnunciante="+"33"/*document.getElementById("idAnunciante").value*/ +
			"&descripcion="+document.getElementById("descripcion").value;
			request.send(pars);
		}

		function subirFoto(){
			var request= new XMLHttpRequest();
			var progreso=document.getElementById("progreso");
			var f=document.getElementById("formFoto");
			var formData=new FormData(f);
			request.open("POST", "SubirFoto.action");
			request.onreadystatechange=function(){
				if(request.readyState==3){
					progreso.innerHTML="Respuesta Recibida";
				}
				if(request.readyState==4){
					var respuesta=JSON.parse(request.responseText);
					respuesta=JSON.parse(respuesta.resultado);
					if(request.status==200){
						progreso.innerHTML="Foto subida correctamente. Id="+respuesta.mensaje;
						cargarZonaDeFotos();
						alert(respuesta.resultado);
					}else{
						progreso.innerHTML=respuesta.mensaje;
					}
				}
			}
			request.send(formData);
		}
	</script>
</body>
</html>
